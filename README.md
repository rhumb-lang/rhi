# rhi: The Rhumb Interpreter

**Version:** v0.3.0 (Library League)

![Vibe Coded](https://img.shields.io/badge/Code_Style-Vibe_Coded-ff69b4?style=flat-square&logo=openai)

> This programming language is a passion project built in my free time. To
> maintain momentum and focus on high-level design, this project is primarily
> **vibe coded**.
>
> **What this means:** I utilize AI tools heavily for implementation speed.
>
> **What this does NOT mean:** I am not blindly committing output. I provide the
> architectural roadmap and the entire ANTLR grammar, I deeply scrutinize the
> generated code, and manually intervene constantly. This workflow allows me to
> build a complex language faster without sacrificing my vision or technical
> standards.

`rhi` is the reference interpreter for Rhumb, an image-based, prototype-oriented
programming language designed to be English-language free.

This repository contains the core runtime (rhi), comprising the lexer, bytecode
compiler, and virtual machine.

## ðŸ“¦ Installation

```bash
# Clone the repository
git clone https://github.com/Hisyeo/rhi.git
cd rhi

# Build the binary
go build -o bin/rhi ./cmd/rhi
```

## ðŸš€ Usage

You can run `rhi` in interactive mode (REPL) or execute scripts directly.

### Interactive Mode (REPL)

Running the binary without arguments starts the Read-Eval-Print Loop.

```console
$ ./bin/rhi
> x := 10
=> 10
> x ** 2
=> 20
```

### Running Scripts

Pass a file path to execute a Rhumb script.

```bash
./bin/rhi ./examples/chat.rh
```

### Command Line Flags

The CLI includes tracing tools for debugging the compiler and VM.

| Flag              | Description                                                                                                                         |
|:------------------|:------------------------------------------------------------------------------------------------------------------------------------|
| `-test`           | **Test Mode.** Runs the script and validates assertions defined by the `%=` operator. Output is suppressed unless a failure occurs. |
| `-silent`         | **Silent Mode.** Run without warning about uncaught signals and other runtime issues.                                               |
| `-sha256`         | **Anchor Mode.** Before interpreting the script or REPL, replace any empty anchors with their actual checksum.                      |
| `-trace-bytecode` | **Compiler Trace.** Prints the disassembled bytecode chunks generated by the compiler before execution.                             |
| `-trace-stack`    | **Stack Trace.** Logs the state of the data stack after every instruction.                                                          |
| `-trace-frame`    | **Frame Trace.** Logs the execution flow, including stack frame creation, instruction pointers, and monitors.                       |
| `-trace-space`    | **Realm Trace.** Logs actor-model events: Realm creation, Signal posting, Listener matching, and Bubbling.                          |
| `-trace-loader`   | **Loader Trace.** Logs library resolution events: Path lookup, version matching, and cycle detection.                               |

**Example: Debugging a script**

```console
$ ./bin/rhi -trace-stack -trace-space ./tests/sieve.rh
```

## âœ… Development Status: v0.4.0 (Zombie Zone)

The asynchronous core is now fully operational. The focus is shifting to hardening the base library and optimizing the VM.

### Changelog: v0.4.0

- [x] **Zombie Frames**: Implemented re-entrant continuation. Functions can now suspend execution (`#signal`), be moved to a "parking lot" (Zombie List), and be revived (`^reply`) later with new data without losing their state.
- [x] **Async Primitives**:
    - [x] **Signals (`#`)**: Fully implemented bubbling up the call stack to find monitors.
    - [x] **Replies (`^`)**: Implemented drilling down into the Zombie list to resume suspended frames.
    - [x] **Anonymous Replies**: Support for `^(val)` syntax (Yield behavior).
- [x] **Effect Monitoring**: Enhanced compilation of `expression { selector }`. Complex expressions (like Block or Map literals) are now wrapped in Thunks to ensuring signals emitted *during* construction are correctly caught by the attached selector.
- [x] **Tooling & CLI**:
    - [x] **Frame Tracing**: Added `-trace-frame` flag for detailed execution debugging.
    - [x] **Silent Mode**: Added `-silent` flag to suppress runtime warnings.
    - [x] **Integrity**: Added `-sha256` flag for catalog anchor management.
- [x] **Project Structure**:
    - [x] **Module Rename**: Migrated Go module to `github.com/rhumb-lang/rhi`.
    - [x] **Documentation**: Added comprehensive guides on Concurrency, Project Structure, and the Unified Activity Model.
- [x] **Resolvers**:
    - [x] **Resource (`=`)**: Support for importing resources from Resource Shelves.
    - [x] **Native (`_`)**: Support for Go function interface.


### Core Features (Implemented previously)

- [x] **Syntax & Grammar**: Full ANTLR4 grammar for Maps, Selectors, and Operators
- [x] **Prototype Model**: Maps (`[...]`), Fields, inheritance (`@`), and mutable/immutable assignment
- [x] **Bytecode Compiler**: Single-pass incremental compiler with lexical scoping and variable hoisting
- [x] **Cactus Stack VM**: Heap-allocated call frames supporting closures (`<fn>`) and "Zombie" frame persistence
- [x] **Concurrency (The Tuplespace)**:
    - [x] Signals (`#`) bubbling up the realm hierarchy
    - [x] Replies (`^`) drilling down into Zombie frames
    - [x] Tuplespaces (`<$>`, `<|>`) and tuple lifecycle pattern-matching
    - [x] Selectors (`{}`) as pattern-matching listeners
- [x] **Control Flow**:
    - [x] Native operators (`=>`, `~>`, `|>`) compiling to jump instructions
    - [x] Pattern Matching (`..`, `::`)
- [x] **Testing Infrastructure**: Built-in assertion runner via the `-test` flag.

### Roadmap to v0.5.0

#### ðŸš§ Missing Grammar Support
- [ ] **Remote Resolvers (`!` / `git`)**: Support for importing directly from git repositories.
- [ ] **Vassals `<{}>`**: Compilation of security proxies.
- [ ] **Keys `` ` ``**: Compilation of private capability keys.
- [ ] **Spread `&`**: Implementation of `[...]` list spreading and slurping.

#### ðŸ“š Base library
- [ ] Implementation of the `math`, `io`, and `sys` libraries.

#### âš¡ Optimizations
- [ ] **Frame Pooling**: Reuse `CallFrame` structs to eliminate GC pressure during recursion (Targeting >5x speedup for `fib`).
- [ ] **Hidden Classes**: Implement the `Legend` transition tree to allow map schema sharing.
- [ ] **Inline Caching**: Cache field lookups in `OP_SEND` to achieve O(1) property access.
- [ ] **Dictionary Mode**: Fallback to Hash Maps for objects with large numbers of fields.

#### ðŸ”® Planned / Concept
- [ ] **The Freezer**: Serialization engine for persisting the Heap/Space to disk (`.ri` files).
- [ ] **RHIDE**: Wayland-native graphical IDE ("Code Projector").
- [ ] **Network Transparency**: Binding Realms to TCP/WebSocket sockets.

## ðŸ§ª Testing

The interpreter includes a suite of tests. Tests are written in Rhumb itself using the `%=` assertion operator.

```rhumb
% Example Test
fib(10) %= 55
```

To run a test, use the `-test` flag:

```console
$ time ./bin/rhi -test ./tests/fib.rh
PASS: 9227465

real    0m11.726s
user    0m15.223s
sys     0m0.618s
```